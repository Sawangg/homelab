---
apiVersion: cilium.io/v2
kind: CiliumEnvoyConfig
metadata:
  name: nginx-forward-auth
  namespace: nginx
spec:
  services:
  - name: nginx
    namespace: nginx
  resources:
  - "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
    name: authentik-forward-auth
    transport_api_version: V3
    http_service:
      server_uri:
        uri: http://ak-outpost-authentik-embedded-outpost.authentik.svc.cluster.local:9000
        cluster: outbound|9000||ak-outpost-authentik-embedded-outpost.authentik.svc.cluster.local
        timeout: 10s
      path_prefix: "/outpost.goauthentik.io/auth/envoy"
      authorization_request:
        allowed_headers:
          patterns:
          - exact: authorization
          - exact: cookie
          - exact: x-forwarded-for
          - exact: x-forwarded-proto
          - exact: x-forwarded-host
      authorization_response:
        allowed_upstream_headers:
          patterns:
          - exact: x-authentik-username
          - exact: x-authentik-groups
          - exact: x-authentik-email
          - exact: x-authentik-name
          - exact: x-authentik-uid
